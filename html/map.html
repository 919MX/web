<!DOCTYPE HTML>
<html>
<head>

  <title>919.MX</title>
  <meta name="description" content="919.MX es una herramienta que ayuda a coordinar los esfuerzos de las organizaciones involucradas en la reconstrucción de México.">

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1" />

  <link rel="stylesheet" type="text/css" href="/styles/global.css">
  <link rel="stylesheet" type="text/css" href="/styles/map.css">
  <link rel="shortcut icon" type="image/ico" href="/assets/img/favicon.ico"/>

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-108487748-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-108487748-1');
  </script>

  <script src='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.40.0/mapbox-gl.css' rel='stylesheet' />
  <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

</head>

<body>

  <header id="beta">

    <div class="container wrap">

      <div class="row">

        <div class="col-lg-2 col-md-2 col-sm-2 col-xs-4">
          <a id="logo" href="/"><img src="/assets/img/logo.svg" width="108px" height="auto" alt="Logo" /></a>
        </div>

        <div class="col-lg-10 col-md-10 col-sm-10 col-xs-8">
          <ul>
            <li>Versión beta</li>
          </ul>
        </div>

      </div>

    </div>

  </header>

<div id='map'></div>

<div class='map-overlay'>
  <fieldset>
    <input id='feature-filter' type='text' placeholder='Buscar localidades' />
  </fieldset>
  <div id='feature-listing' class='listing'></div>
</div>


<script type="text/javascript">
mapboxgl.accessToken = 'pk.eyJ1Ijoia3lsZWJlYmFrIiwiYSI6ImNqOTV2emYzdjIxbXEyd3A2Ynd2d2s0dG4ifQ.W9vKUEkm1KtmR66z_dhixA';
var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/kylebebak/cj95wutp2hbr22smynacs9gnk',
  zoom: 7.5,
  center: [-95.7642505, 16.6073688]
});

// creates a popup, but doesn't add it to map yet
var popup = new mapboxgl.Popup({
  closeButton: false
});

var locs = []; // holds visible locality features for filtering

var filterEl = document.getElementById('feature-filter');
var listingEl = document.getElementById('feature-listing');

function renderListings(features) {
  // clear any existing listings
  listingEl.innerHTML = '';
  features.forEach(function(feature) {
    var prop = feature.properties;
    var item = document.createElement('a');
    item.textContent = prop.NOM_LOC;
    item.addEventListener('mouseover', function() {
      // highlight corresponding feature on the map
      popup.setLngLat(feature.geometry.coordinates)
        .setText(feature.properties.NOM_LOC)
        .addTo(map);
    });
    listingEl.appendChild(item);
  });

  // show the filter input
  filterEl.parentNode.style.display = 'block';
}

function normalize(string) {
  return string.trim().toLowerCase();
}

function deduplicate(features, comparatorProperty) {
  var existingFeatureKeys = {};
  // Because features come from tiled vector data, feature geometries may be split
  // or duplicated across tile boundaries and, as a result, features may appear
  // multiple times in query results.
  var uniqueFeatures = features.filter(function(el) {
    if (existingFeatureKeys[el.properties[comparatorProperty]]) {
      return false;
    } else {
      existingFeatureKeys[el.properties[comparatorProperty]] = true;
      return true;
    }
  });

  return uniqueFeatures;
}

map.on('load', function () {
  map.addLayer({
    id: 'damage',
    type: 'circle',
    source: {
      type: 'vector',
      url: 'mapbox://kylebebak.4nmivsgk'
    },
    'source-layer': 'oaxaca-2-5tgore',
    paint: {
      'circle-radius': {
        property: 'Cont total',
        type: 'exponential',
        stops: [
          [1, 3],
          [15000, 30]
        ]
      },
      'circle-color': {
        property: 'Cont total',
        type: 'exponential',
        stops: [
          [1, '#fbe08b'],
          [15000, '#f54e4e']
        ]
      },
      'circle-opacity': 0.9,
    }
  });

  map.on('mousemove', 'damage', function(e) {
    // change the cursor style as a ui indicator
    map.getCanvas().style.cursor = 'pointer';

    // populate the popup and set its coordinates based on the feature
    var feature = e.features[0];
    popup.setLngLat(feature.geometry.coordinates)
      .setText(feature.properties.NOM_LOC)
      .addTo(map);
  });

  map.on('mouseleave', 'damage', function() {
    map.getCanvas().style.cursor = '';
    popup.remove();
  });

  filterEl.addEventListener('keyup', function(e) {
    var value = normalize(e.target.value);

    // filter visible features that don't match the input value
    var filtered = locs.filter(function(feature) {
      var NOM_LOC = normalize(feature.properties.NOM_LOC);
      return NOM_LOC.indexOf(value) > -1;
    });

    // populate the sidebar with filtered results
    renderListings(filtered);

    // set the filter to populate features into the layer
    map.setFilter('damage', ['in', 'NOM_LOC'].concat(
      filtered.map(function(feature) {
        return feature.properties.NOM_LOC;
      })
    ));
  });

  // call this function on initialization
  map.on('data', (data) => {
    if (data.dataType === 'source' && data.isSourceLoaded) {
      var features = map.querySourceFeatures('damage', {sourceLayer: 'oaxaca-2-5tgore'});
      var uniqueFeatures = deduplicate(features, 'NOM_LOC');
      locs = uniqueFeatures;
      renderListings(uniqueFeatures);
    }
  });
});
</script>

</body>

</html>
